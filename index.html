<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Cat | Smart Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;700&family=Inter:wght@400;600;800&display=swap');
        
        body { 
            font-family: 'Inter', 'Noto Sans Bengali', sans-serif; 
            overflow: hidden; 
            height: 100dvh; 
            background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);
            touch-action: none; 
        }
        
        #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000; }
        #overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 900; backdrop-filter: blur(4px); }
        
        /* Cat Stage */
        #cat-wrapper {
            position: relative;
            transform-origin: bottom center;
            transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        /* Emotion States */
        .emotion-happy { animation: bounce 1s infinite; }
        .emotion-sad { transform: translateY(20px) scale(0.95); filter: brightness(0.8); }
        .emotion-angry { animation: shake 0.5s infinite; filter: hue-rotate(-30deg) brightness(0.9); }
        .emotion-love { animation: heartbeat 1.2s infinite; filter: hue-rotate(30deg); }
        .emotion-scared { transform: scale(0.9); animation: tremble 0.3s infinite; }
        
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes tremble { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(3px); } }
        @keyframes heartbeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.08); } }
        
        /* Head Animations */
        .is-speaking #head-group { animation: wobble 0.3s infinite alternate; }
        @keyframes wobble { from { transform: rotate(-3deg); } to { transform: rotate(3deg); } }
        
        /* Eye Animations */
        .eye-lid { transform-origin: center; transition: transform 0.1s; }
        .blink .eye-lid { transform: scaleY(0.1); }
        .emotion-sad .eye-lid { transform: scaleY(0.6) translateY(2px); }
        .emotion-angry .eye-lid { transform: scaleY(0.7) rotate(15deg); }
        .emotion-love .eye-lid { transform: scaleY(0.2); }
        
        /* Tail */
        #tail {
            transform-origin: 160px 180px;
            animation: tailWag 2s infinite ease-in-out;
        }
        @keyframes tailWag { 0%, 100% { transform: rotate(0deg); } 50% { transform: rotate(15deg); } }
        .emotion-happy #tail, .emotion-love #tail { animation: tailWagFast 0.4s infinite; }
        @keyframes tailWagFast { 0%, 100% { transform: rotate(-15deg); } 50% { transform: rotate(25deg); } }
        .emotion-sad #tail { animation: none; transform: rotate(-25deg); }
        .emotion-angry #tail { animation: tailFlick 0.15s infinite; }
        @keyframes tailFlick { 0%, 100% { transform: rotate(0deg); } 50% { transform: rotate(-35deg); } }
        
        /* Speech Bubble */
        #speech-bubble { 
            position: absolute; 
            z-index: 100; 
            width: 85vw; 
            max-width: 320px; 
            touch-action: none;
            transition: all 0.3s;
        }
        
        /* Effects */
        .heart-particle {
            position: absolute;
            color: #ec4899;
            font-size: 24px;
            animation: floatUp 1.5s ease-out forwards;
            pointer-events: none;
            z-index: 50;
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(0); }
            50% { transform: translateY(-60px) scale(1.2); }
            100% { opacity: 0; transform: translateY(-120px) scale(0.5); }
        }
        
        .tear {
            position: absolute;
            width: 10px;
            height: 14px;
            background: #60a5fa;
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            animation: fall 1.2s linear forwards;
            z-index: 50;
        }
        @keyframes fall { to { transform: translateY(80px); opacity: 0; } }
        
        /* Interaction Zones Overlay */
        .touch-zone {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 50%;
            z-index: 20;
            cursor: pointer;
        }
        .touch-zone-left { left: 0; }
        .touch-zone-right { right: 0; }
        
        .zone-indicator {
            position: absolute;
            top: 30%;
            font-size: 40px;
            opacity: 0;
            transition: all 0.3s;
            pointer-events: none;
            z-index: 15;
        }
        .zone-left-indicator { left: 15%; }
        .zone-right-indicator { right: 15%; }
        
        .touch-zone:active + .zone-indicator,
        .touch-zone-left:active ~ .zone-left-indicator,
        .touch-zone-right:active ~ .zone-right-indicator {
            opacity: 1;
            transform: scale(1.3);
        }
        
        /* Listening State */
        .is-listening #cat-wrapper::after {
            content: '';
            position: absolute;
            inset: -20px;
            border: 4px solid #6366f1;
            border-radius: 50%;
            animation: pulseRing 1.5s infinite;
            pointer-events: none;
        }
        @keyframes pulseRing {
            0% { transform: scale(0.9); opacity: 1; }
            100% { transform: scale(1.4); opacity: 0; }
        }
        
        /* Mobile */
        @media (max-width: 640px) {
            #cat-wrapper { transform: scale(0.9); }
        }
    </style>
</head>
<body>

    <div id="overlay" onclick="toggleSidebar()"></div>

    <aside id="sidebar" class="fixed inset-y-0 left-0 w-72 bg-white/95 backdrop-blur shadow-2xl transform -translate-x-full">
        <div class="p-6 h-full flex flex-col">
            <h2 class="text-xl font-black text-indigo-600 mb-8 italic">SETTINGS</h2>
            <div class="space-y-6 flex-1">
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">OpenRouter API Key</label>
                    <input type="password" id="api-key" placeholder="sk-or-..." class="w-full mt-2 p-3 bg-gray-100 rounded-xl border-none text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Model ID</label>
                    <input type="text" id="model-profile" value="google/gemini-2.0-flash-exp:free" class="w-full mt-2 p-3 bg-gray-100 rounded-xl border-none text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
            </div>
            <button onclick="saveSettings()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-indigo-700 transition-colors">Save Config</button>
        </div>
    </aside>

    <main class="flex flex-col h-full relative">
        <header class="p-4 flex gap-2 items-center pointer-events-none z-50">
            <button onclick="toggleSidebar()" class="pointer-events-auto w-10 h-10 bg-white rounded-xl shadow text-indigo-600 hover:bg-indigo-50 transition-colors">
                <i class="fas fa-cog"></i>
            </button>
            <div class="pointer-events-auto flex-1 bg-white/90 backdrop-blur rounded-xl shadow p-1 flex items-center h-10">
                <input type="text" id="text-input" placeholder="Type or use voice..." class="flex-1 bg-transparent px-3 text-sm outline-none border-none" onkeydown="if(event.key==='Enter') sendText()">
                <button onclick="sendText()" class="w-8 h-8 bg-indigo-600 text-white rounded-lg flex items-center justify-center hover:bg-indigo-700 transition-colors">
                    <i class="fas fa-paper-plane text-[10px]"></i>
                </button>
            </div>
        </header>

        <div class="flex-1 flex flex-col items-center justify-center relative overflow-hidden">
            <!-- Speech Bubble -->
            <div id="speech-bubble" style="left: 50%; top: 40px; transform: translateX(-50%);">
                <div class="bg-white/95 backdrop-blur p-4 rounded-[2rem] shadow-xl border border-white/50">
                    <div id="drag-handle" class="w-8 h-1 bg-gray-200 mx-auto mb-2 rounded-full cursor-move"></div>
                    <p id="user-transcript" class="text-indigo-600 font-bold text-xs min-h-[1rem] mb-1 opacity-60"></p>
                    <p id="ai-caption" class="text-gray-800 text-lg font-bold bangla-text leading-relaxed">‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã!</p>
                    <p id="english-sub" class="text-gray-400 text-xs italic mt-1 pt-1 border-t border-gray-100">Hello!</p>
                </div>
            </div>

            <!-- Cat Container with Touch Zones -->
            <div id="cat-container" class="relative flex items-center justify-center" style="width: 300px; height: 350px;">
                <div id="cat-wrapper">
                    <!-- Touch Zones -->
                    <div class="touch-zone touch-zone-left" onmousedown="startPet()" onmouseup="endPet()" ontouchstart="startPet()" ontouchend="endPet()"></div>
                    <div class="touch-zone touch-zone-right" onmousedown="startScold()" onmouseup="endScold()" ontouchstart="startScold()" ontouchend="endScold()"></div>
                    
                    <!-- Zone Indicators -->
                    <div class="zone-indicator zone-left-indicator">‚ù§Ô∏è</div>
                    <div class="zone-indicator zone-right-indicator">üòæ</div>

                    <svg viewBox="0 0 200 240" class="w-64 h-64 sm:w-72 sm:h-72 lg:w-80 lg:h-80">
                        <!-- Shadow -->
                        <ellipse cx="100" cy="230" rx="70" ry="12" fill="#000" opacity="0.08" />
                        
                        <!-- Tail -->
                        <path id="tail" d="M160 200 Q185 170 175 140 Q165 110 180 95" stroke="#4338ca" stroke-width="14" fill="none" stroke-linecap="round" />
                        
                        <!-- Body -->
                        <ellipse cx="100" cy="190" rx="55" ry="45" fill="#6366f1" />
                        <path d="M60 220 Q100 160 140 220" fill="#4f46e5" />
                        
                        <!-- Paws -->
                        <ellipse cx="70" cy="225" rx="15" ry="10" fill="#e0e7ff" />
                        <ellipse cx="130" cy="225" rx="15" ry="10" fill="#e0e7ff" />
                        
                        <!-- Head Group -->
                        <g id="head-group" style="transform-origin: 100px 100px;">
                            <!-- Ears -->
                            <path d="M50 50 L25 5 L70 35 Z" fill="#4338ca" />
                            <path d="M150 50 L175 5 L130 35 Z" fill="#4338ca" />
                            <path d="M58 42 L42 18 L68 32 Z" fill="#818cf8" />
                            <path d="M142 42 L158 18 L132 32 Z" fill="#818cf8" />
                            
                            <!-- Face -->
                            <circle cx="100" cy="110" r="85" fill="#6366f1" />
                            <ellipse cx="100" cy="125" rx="65" ry="55" fill="#e0e7ff" />
                            
                            <!-- Eyes -->
                            <g id="eyes" style="transform-origin: center;">
                                <ellipse class="eye-lid" cx="75" cy="115" rx="10" ry="10" fill="#1e293b" />
                                <ellipse class="eye-lid" cx="125" cy="115" rx="10" ry="10" fill="#1e293b" />
                                <circle cx="78" cy="112" r="4" fill="white" opacity="0.7" />
                                <circle cx="128" cy="112" r="4" fill="white" opacity="0.7" />
                            </g>
                            
                            <!-- Nose -->
                            <path d="M92 140 L108 140 L100 150 Z" fill="#f472b6" />
                            
                            <!-- Mouth -->
                            <path id="mouth" d="M85 155 Q100 165 115 155" stroke="#1e293b" stroke-width="3" fill="none" stroke-linecap="round" />
                            
                            <!-- Whiskers -->
                            <g stroke="#1e293b" stroke-width="1.5" opacity="0.5">
                                <line x1="35" y1="125" x2="70" y2="130" />
                                <line x1="32" y1="140" x2="70" y2="140" />
                                <line x1="35" y1="155" x2="70" y2="150" />
                                <line x1="165" y1="125" x2="130" y2="130" />
                                <line x1="168" y1="140" x2="130" y2="140" />
                                <line x1="165" y1="155" x2="130" y2="150" />
                            </g>
                            
                            <!-- Cheeks -->
                            <circle cx="60" cy="140" r="10" fill="#f472b6" opacity="0.25" />
                            <circle cx="140" cy="140" r="10" fill="#f472b6" opacity="0.25" />
                        </g>
                    </svg>
                </div>
            </div>

            <!-- Controls -->
            <div class="absolute bottom-12 flex flex-col items-center gap-3 z-50">
                <div class="flex gap-3 items-center">
                    <button onclick="manualEmotion('love')" class="w-12 h-12 bg-white rounded-full shadow-lg flex items-center justify-center text-xl hover:scale-110 active:scale-95 transition-transform">ü•∞</button>
                    
                    <button id="mic-btn" onclick="toggleMic()" class="w-16 h-16 bg-white rounded-full shadow-2xl flex items-center justify-center text-2xl active:scale-90 transition-all duration-200">
                        <i id="mic-icon" class="fas fa-microphone text-gray-300"></i>
                    </button>
                    
                    <button onclick="manualEmotion('sad')" class="w-12 h-12 bg-white rounded-full shadow-lg flex items-center justify-center text-xl hover:scale-110 active:scale-95 transition-transform">üòø</button>
                </div>
                <div class="flex gap-2 items-center bg-white/90 backdrop-blur px-4 py-2 rounded-full shadow text-xs font-bold">
                    <span id="status-tag" class="text-gray-500">READY</span>
                    <span class="text-gray-300">|</span>
                    <span id="emotion-tag" class="text-indigo-600">NEUTRAL</span>
                </div>
            </div>
        </div>
    </main>

    <script>
        const STATE = {
            listening: false,
            speaking: false,
            emotion: 'neutral',
            config: {
                key: localStorage.getItem('cat_key') || '',
                model: localStorage.getItem('cat_model') || 'google/gemini-2.0-flash-exp:free'
            },
            petTimer: null,
            scoldTimer: null,
            lastSpeechTime: 0
        };

        const EMOTIONS = {
            neutral: { class: '', bn: '‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã!', en: 'Hello!' },
            happy: { class: 'emotion-happy', bn: '‡¶ñ‡ßÅ‡¶∂‡¶ø!', en: 'So happy!' },
            love: { class: 'emotion-love', bn: '‡¶≠‡¶æ‡¶≤‡ßã‡¶¨‡¶æ‡¶∏‡¶ø!', en: 'Love you!' },
            sad: { class: 'emotion-sad', bn: '‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§...', en: 'Sorry...' },
            angry: { class: 'emotion-angry', bn: '‡¶∞‡¶æ‡¶ó‡¶æ‡¶®‡ßç‡¶¨‡¶ø‡¶§!', en: 'Angry!' },
            scared: { class: 'emotion-scared', bn: '‡¶≠‡¶Ø‡¶º ‡¶™‡ßá‡¶Ø‡¶º‡ßá‡¶õ‡¶ø!', en: 'Scared!' }
        };

        // --- TOUCH INTERACTIONS (FIXED) ---
        function startPet() {
            clearTimeout(STATE.petTimer);
            setEmotion('love');
            createHearts();
            STATE.petTimer = setTimeout(() => {
                speak("Purr... I love you!", "‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶ó‡ßÅ‡¶∞‡ßÅ... ‡¶Ü‡¶Æ‡¶ø ‡¶§‡ßã‡¶Æ‡¶æ‡¶ï‡ßá ‡¶≠‡¶æ‡¶≤‡ßã‡¶¨‡¶æ‡¶∏‡¶ø!");
            }, 300);
        }

        function endPet() {
            clearTimeout(STATE.petTimer);
        }

        function startScold() {
            clearTimeout(STATE.scoldTimer);
            setEmotion('angry');
            STATE.scoldTimer = setTimeout(() => {
                setEmotion('sad');
                createTears();
                speak("Meow... why scold me?", "‡¶Æ‡¶ø‡¶â... ‡¶ï‡ßá‡¶® ‡¶¨‡¶ï‡¶õ‡ßã?");
            }, 600);
        }

        function endScold() {
            clearTimeout(STATE.scoldTimer);
        }

        function manualEmotion(emo) {
            setEmotion(emo);
            if (emo === 'love') {
                createHearts();
                speak("Purr purr!", "‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶ó‡ßÅ‡¶∞‡ßÅ!");
            } else if (emo === 'sad') {
                createTears();
                speak("Don't be sad...", "‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§ ‡¶π‡ßã‡¶Ø‡¶º‡ßã ‡¶®‡¶æ...");
            }
        }

        // --- EMOTION SYSTEM ---
        function setEmotion(emotion) {
            const wrapper = document.getElementById('cat-wrapper');
            const tag = document.getElementById('emotion-tag');
            
            Object.keys(EMOTIONS).forEach(e => wrapper.classList.remove(EMOTIONS[e].class));
            
            STATE.emotion = emotion;
            wrapper.classList.add(EMOTIONS[emotion].class);
            tag.innerText = emotion.toUpperCase();
            
            // Update caption for manual emotions
            if (EMOTIONS[emotion]) {
                document.getElementById('ai-caption').innerText = EMOTIONS[emotion].bn;
                document.getElementById('english-sub').innerText = EMOTIONS[emotion].en;
            }
        }

        function createHearts() {
            const container = document.getElementById('cat-container');
            for (let i = 0; i < 6; i++) {
                setTimeout(() => {
                    const heart = document.createElement('div');
                    heart.className = 'heart-particle';
                    heart.innerHTML = ['üíï', 'üíñ', 'üíó'][Math.floor(Math.random() * 3)];
                    heart.style.left = (60 + Math.random() * 80) + 'px';
                    heart.style.top = (80 + Math.random() * 40) + 'px';
                    container.appendChild(heart);
                    setTimeout(() => heart.remove(), 1500);
                }, i * 150);
            }
        }

        function createTears() {
            const eyes = document.getElementById('eyes');
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const tear = document.createElement('div');
                    tear.className = 'tear';
                    tear.style.left = (i % 2 === 0 ? 70 : 120) + 'px';
                    tear.style.top = '125px';
                    eyes.appendChild(tear);
                    setTimeout(() => tear.remove(), 1200);
                }, i * 300);
            }
        }

        // --- SPEECH RECOGNITION (BUG FIX: Stop listening while speaking) ---
        const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
        let rec = null;
        
        if (Rec) {
            rec = new Rec();
            rec.lang = 'en-US';
            rec.continuous = false;
            rec.interimResults = false;
            
            rec.onstart = () => {
                STATE.listening = true;
                updateUI('LISTENING');
                document.body.classList.add('is-listening');
                document.getElementById('status-tag').innerText = 'LISTENING';
            };
            
            rec.onresult = (e) => {
                const txt = e.results[0][0].transcript;
                document.getElementById('user-transcript').innerText = '"' + txt + '"';
                // Stop listening immediately after getting result
                rec.stop();
                STATE.listening = false;
                document.body.classList.remove('is-listening');
                callAI(txt);
            };
            
            rec.onend = () => {
                STATE.listening = false;
                document.body.classList.remove('is-listening');
                // Only auto-restart if not speaking and user wants mic on
                // But we disabled auto-restart to prevent hearing itself
            };
            
            rec.onerror = (e) => {
                console.log('Speech error:', e.error);
                STATE.listening = false;
                document.body.classList.remove('is-listening');
                updateUI('STANDBY');
            };
        }

        function toggleMic() {
            if (!rec) {
                alert("Speech recognition not supported!");
                return;
            }
            
            if (STATE.listening) {
                rec.stop();
                STATE.listening = false;
                updateUI('STANDBY');
            } else {
                // Don't start if currently speaking
                if (STATE.speaking) {
                    window.speechSynthesis.cancel();
                    STATE.speaking = false;
                }
                rec.start();
            }
        }

        // --- AI & SPEECH (OpenRouter) ---
        async function callAI(text) {
            if (!STATE.config.key) {
                alert("Please add your OpenRouter API Key!");
                toggleSidebar();
                return;
            }

            updateUI('THINKING');
            document.getElementById('status-tag').innerText = 'THINKING';

            // Detect emotion from text
            const lower = text.toLowerCase();
            if (lower.includes('love') || lower.includes('like') || lower.includes('good')) {
                setEmotion('love');
            } else if (lower.includes('bad') || lower.includes('stupid') || lower.includes('hate')) {
                setEmotion('sad');
                setTimeout(() => createTears(), 500);
            } else if (lower.includes('sorry') || lower.includes('apologize')) {
                setEmotion('love');
                createHearts();
            }

            const prompt = `You are a cute robot cat. Reply in English (1 short sentence), then add Bangla translation on new line starting with "BN:".
            User said: "${text}"`;

            try {
                const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${STATE.config.key}`,
                        "Content-Type": "application/json",
                        "HTTP-Referer": window.location.href,
                        "X-Title": "AI Cat"
                    },
                    body: JSON.stringify({
                        model: STATE.config.model,
                        messages: [{ role: 'user', content: prompt }]
                    })
                });

                const data = await res.json();
                const reply = data.choices[0].message.content;
                
                // Parse response
                const lines = reply.split('\n').filter(l => l.trim());
                let english = lines[0].replace(/^EN:\s*/i, '').trim();
                let bangla = lines.find(l => l.toUpperCase().startsWith('BN:'))?.replace(/^BN:\s*/i, '').trim() ||
                            lines[1]?.replace(/^BN:\s*/i, '').trim() ||
                            "‡¶¨‡ßÅ‡¶ù‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶ø‡¶®‡¶ø";
                
                document.getElementById('ai-caption').innerText = bangla;
                document.getElementById('english-sub').innerText = english;
                
                speak(english, bangla);
                
            } catch (e) {
                console.error(e);
                updateUI('STANDBY');
                document.getElementById('status-tag').innerText = 'ERROR';
                speak("Meow! Error!", "‡¶Æ‡¶ø‡¶â! ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ!");
            }
        }

        function speak(english, bangla) {
            STATE.speaking = true;
            STATE.lastSpeechTime = Date.now();
            window.speechSynthesis.cancel();
            
            const ut = new SpeechSynthesisUtterance(english);
            ut.lang = 'en-US';
            ut.rate = 1;
            ut.pitch = 1.1;
            
            const mouth = document.getElementById('mouth');
            let mouthAnim;
            
            ut.onstart = () => {
                updateUI('SPEAKING');
                document.body.classList.add('is-speaking');
                document.getElementById('status-tag').innerText = 'SPEAKING';
                
                // Animate mouth
                mouthAnim = setInterval(() => {
                    const open = Math.random() > 0.3;
                    mouth.setAttribute('d', open ? 'M85 155 Q100 170 115 155' : 'M85 155 Q100 160 115 155');
                }, 80);
            };
            
            ut.onend = () => {
                STATE.speaking = false;
                clearInterval(mouthAnim);
                mouth.setAttribute('d', 'M85 155 Q100 165 115 155');
                document.body.classList.remove('is-speaking');
                updateUI('STANDBY');
                document.getElementById('status-tag').innerText = 'READY';
            };
            
            window.speechSynthesis.speak(ut);
        }

        function sendText() {
            const input = document.getElementById('text-input');
            const txt = input.value.trim();
            if (!txt) return;
            
            document.getElementById('user-transcript').innerText = '"' + txt + '"';
            callAI(txt);
            input.value = '';
            input.blur();
        }

        // --- UI HELPERS ---
        function updateUI(status) {
            const icon = document.getElementById('mic-icon');
            const btn = document.getElementById('mic-btn');
            
            if (status === 'LISTENING') {
                icon.className = "fas fa-microphone text-indigo-600 animate-pulse";
                btn.classList.add('ring-4', 'ring-indigo-300');
            } else if (status === 'SPEAKING') {
                icon.className = "fas fa-volume-up text-green-500";
                btn.classList.remove('ring-4', 'ring-indigo-300');
            } else if (status === 'THINKING') {
                icon.className = "fas fa-circle-notch fa-spin text-orange-500";
                btn.classList.remove('ring-4', 'ring-indigo-300');
            } else {
                icon.className = "fas fa-microphone text-gray-300";
                btn.classList.remove('ring-4', 'ring-indigo-300');
            }
        }

        function toggleSidebar() {
            const el = document.getElementById('sidebar');
            const isOpen = el.style.transform === 'translateX(0px)';
            el.style.transform = isOpen ? 'translateX(-100%)' : 'translateX(0px)';
            document.getElementById('overlay').style.display = isOpen ? 'none' : 'block';
        }

        function saveSettings() {
            STATE.config.key = document.getElementById('api-key').value;
            STATE.config.model = document.getElementById('model-profile').value;
            localStorage.setItem('cat_key', STATE.config.key);
            localStorage.setItem('cat_model', STATE.config.model);
            toggleSidebar();
            speak("Settings saved!", "‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§!");
        }

        // --- INIT ---
        window.onload = () => {
            document.getElementById('api-key').value = STATE.config.key;
            document.getElementById('model-profile').value = STATE.config.model;
            
            // Draggable bubble
            const bubble = document.getElementById('speech-bubble');
            let px = 0, py = 0, startX, startY;
            
            document.getElementById('drag-handle').onpointerdown = (e) => {
                startX = e.clientX - px;
                startY = e.clientY - py;
                
                document.onpointermove = (ev) => {
                    px = ev.clientX - startX;
                    py = ev.clientY - startY;
                    bubble.style.transform = `translate3d(calc(-50% + ${px}px), ${py}px, 0)`;
                };
                
                document.onpointerup = () => {
                    document.onpointermove = null;
                };
            };
            
            // Auto blink
            setInterval(() => {
                document.getElementById('eyes').classList.add('blink');
                setTimeout(() => document.getElementById('eyes').classList.remove('blink'), 150);
            }, 4000);
            
            // Welcome
            setTimeout(() => {
                speak("Hello! Tap left to pet, right to scold!", 
                      "‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã! ‡¶¨‡¶æ‡¶Æ‡ßá ‡¶ü‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡¶∞‡ßã ‡¶Ü‡¶¶‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá, ‡¶°‡¶æ‡¶®‡ßá ‡¶¨‡¶ï‡¶æ‡¶ù‡¶ï‡¶æ ‡¶ï‡¶∞‡¶§‡ßá!");
            }, 800);
        };
    </script>
</body>
</html>
