<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Cat | Emo Robot Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;700&family=Inter:wght@400;600;800&display=swap');
        
        body { 
            font-family: 'Inter', 'Noto Sans Bengali', sans-serif; 
            overflow: hidden; 
            height: 100dvh; 
            background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);
            touch-action: none; 
        }
        
        #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000; }
        #overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 900; backdrop-filter: blur(4px); }
        
        /* Cat Stage & Animations */
        #cat-stage { 
            transform-origin: bottom center; 
            cursor: pointer;
            transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            position: relative;
        }
        
        /* Emotion States */
        .emotion-happy { animation: bounce 1s infinite; }
        .emotion-sad { transform: translateY(20px) scale(0.95); filter: brightness(0.8); }
        .emotion-angry { animation: shake 0.5s infinite; filter: hue-rotate(-30deg) brightness(0.9); }
        .emotion-scared { transform: scale(0.9) translateY(10px); animation: tremble 0.3s infinite; }
        .emotion-love { animation: heartbeat 1.2s infinite; filter: hue-rotate(30deg); }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px) rotate(-2deg); }
            75% { transform: translateX(5px) rotate(2deg); }
        }
        @keyframes tremble {
            0%, 100% { transform: translateX(0) scale(0.9); }
            50% { transform: translateX(2px) scale(0.9); }
        }
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* Head Animations */
        .is-talking #head-group { animation: wobble 0.3s infinite alternate; }
        @keyframes wobble { from { transform: rotate(-4deg); } to { transform: rotate(4deg); } }
        
        /* Eye Animations */
        .eye-lid { transform-origin: center; transition: transform 0.1s; }
        .blink .eye-lid { transform: scaleY(0.1); }
        .emotion-sad .eye-lid { transform: scaleY(0.6) translateY(2px); }
        .emotion-angry .eye-lid { transform: scaleY(0.8) rotate(10deg); }
        .emotion-love .eye-lid { transform: scaleY(0.3); }
        
        /* Tail Animation */
        #tail {
            transform-origin: 160px 180px;
            animation: tailWag 2s infinite ease-in-out;
        }
        @keyframes tailWag {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(15deg); }
        }
        .emotion-happy #tail { animation: tailWagFast 0.5s infinite; }
        @keyframes tailWagFast {
            0%, 100% { transform: rotate(-10deg); }
            50% { transform: rotate(25deg); }
        }
        .emotion-sad #tail { animation: none; transform: rotate(-20deg); }
        .emotion-angry #tail { animation: tailFlick 0.2s infinite; }
        @keyframes tailFlick {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(-30deg); }
        }
        
        /* Speech Bubble */
        #speech-bubble { 
            position: absolute; 
            z-index: 100; 
            width: 85vw; 
            max-width: 320px; 
            touch-action: none;
            transition: opacity 0.3s;
        }
        
        /* Floating Hearts for Love */
        .heart-particle {
            position: absolute;
            color: #ec4899;
            font-size: 24px;
            animation: floatUp 1.5s ease-out forwards;
            pointer-events: none;
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(0); }
            50% { transform: translateY(-50px) scale(1.2); }
            100% { opacity: 0; transform: translateY(-100px) scale(0.5); }
        }
        
        /* Tear drops for Sad */
        .tear {
            position: absolute;
            width: 8px;
            height: 12px;
            background: #60a5fa;
            border-radius: 50%;
            animation: fall 1s linear forwards;
        }
        @keyframes fall {
            to { transform: translateY(60px); opacity: 0; }
        }
        
        /* Interaction Zones */
        .interaction-hint {
            position: absolute;
            background: rgba(255,255,255,0.9);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: #4f46e5;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            white-space: nowrap;
        }
        
        /* Progress Ring for Listening */
        .listening-ring {
            position: absolute;
            inset: -10px;
            border: 3px solid #6366f1;
            border-radius: 50%;
            opacity: 0;
            animation: pulseRing 1.5s infinite;
        }
        @keyframes pulseRing {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(1.3); opacity: 0; }
        }
        .is-listening .listening-ring { opacity: 1; }
        
        /* Bangla Subtitle Style */
        .bangla-text {
            font-family: 'Noto Sans Bengali', sans-serif;
            line-height: 1.6;
        }
        
        /* Mobile Optimizations */
        @media (max-width: 640px) {
            #cat-stage { transform: scale(0.85); }
        }
    </style>
<base target="_blank">
</head>
<body>

    <div id="overlay" onclick="toggleSidebar()"></div>

    <aside id="sidebar" class="fixed inset-y-0 left-0 w-72 bg-white/95 backdrop-blur shadow-2xl transform -translate-x-full">
        <div class="p-6 h-full flex flex-col">
            <h2 class="text-xl font-black text-indigo-600 mb-8 italic">SETTINGS</h2>
            <div class="space-y-6 flex-1">
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">OpenRouter API Key</label>
                    <input type="password" id="api-key" placeholder="sk-or-..." class="w-full mt-2 p-3 bg-gray-100 rounded-xl border-none text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Model ID</label>
                    <input type="text" id="model-profile" value="google/gemini-2.0-flash-exp:free" class="w-full mt-2 p-3 bg-gray-100 rounded-xl border-none text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="p-4 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl border border-indigo-100">
                    <p class="text-[10px] text-indigo-700 font-bold uppercase mb-2">üé≠ Emotion Triggers:</p>
                    <ul class="text-[11px] text-indigo-600 space-y-1">
                        <li>‚Ä¢ "I love you" ‚Üí üíï Happy</li>
                        <li>‚Ä¢ "Bad cat" / Scolding ‚Üí üò† Angry</li>
                        <li>‚Ä¢ "Don't cry" ‚Üí üò¢ Sad</li>
                        <li>‚Ä¢ Tap body ‚Üí ü•∞ Pet/Love</li>
                        <li>‚Ä¢ Long press ‚Üí üòø Sad/Apologize</li>
                    </ul>
                </div>
            </div>
            <button onclick="saveSettings()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-indigo-700 transition-colors">Save Config</button>
        </div>
    </aside>

    <main class="flex flex-col h-full relative">
        <header class="p-4 flex gap-2 items-center pointer-events-none z-50">
            <button onclick="toggleSidebar()" class="pointer-events-auto w-10 h-10 bg-white rounded-xl shadow text-indigo-600 hover:bg-indigo-50 transition-colors"><i class="fas fa-cog"></i></button>
            <div class="pointer-events-auto flex-1 bg-white/90 backdrop-blur rounded-xl shadow p-1 flex items-center h-10">
                <input type="text" id="text-input" placeholder="Say something or tap the cat..." class="flex-1 bg-transparent px-3 text-sm outline-none border-none" onkeydown="if(event.key==='Enter') sendText()">
                <button onclick="sendText()" class="w-8 h-8 bg-indigo-600 text-white rounded-lg flex items-center justify-center hover:bg-indigo-700 transition-colors"><i class="fas fa-paper-plane text-[10px]"></i></button>
            </div>
        </header>

        <div class="flex-1 flex flex-col items-center justify-center relative overflow-hidden">
            <!-- Interaction Hints -->
            <div id="hint-pet" class="interaction-hint" style="top: 30%; left: 20%;">üëÜ Tap to pet</div>
            <div id="hint-scold" class="interaction-hint" style="top: 30%; right: 20%;">üëÜ Long press to scold</div>

            <!-- Speech Bubble -->
            <div id="speech-bubble" style="left: 20px; top: 60px;">
                <div class="bg-white/95 backdrop-blur p-5 rounded-[2rem] shadow-xl border border-white/50">
                    <div id="drag-handle" class="w-10 h-1 bg-gray-200 mx-auto mb-3 rounded-full cursor-move"></div>
                    <p id="user-transcript" class="text-indigo-600 font-bold text-sm min-h-[1.2rem] mb-1"></p>
                    <p id="ai-caption" class="text-gray-800 text-base font-medium bangla-text">‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã! ‡¶Ü‡¶Æ‡¶ø ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶¨‡ßÅ‡¶¶‡ßç‡¶ß‡¶ø‡¶Æ‡¶æ‡¶® ‡¶¨‡¶ø‡¶°‡¶º‡¶æ‡¶≤‡•§</p>
                    <p id="english-sub" class="text-gray-400 text-xs italic mt-2 border-t border-gray-100 pt-2">Hello! I'm your smart cat.</p>
                </div>
            </div>

            <!-- Cat Character -->
            <div id="cat-container" class="relative">
                <div class="listening-ring"></div>
                <div id="cat-stage" onclick="handleTap(event)" onmousedown="handleMouseDown(event)" ontouchstart="handleTouchStart(event)" ontouchend="handleTouchEnd(event)">
                    <svg viewBox="0 0 200 220" class="w-72 h-72 sm:w-80 sm:h-80 lg:w-[450px] lg:h-[500px]">
                        <!-- Shadow -->
                        <ellipse cx="100" cy="210" rx="60" ry="10" fill="#000" opacity="0.1" />
                        
                        <!-- Tail -->
                        <path id="tail" d="M160 180 Q180 160 170 140 Q160 120 175 110" stroke="#4338ca" stroke-width="12" fill="none" stroke-linecap="round" />
                        
                        <!-- Body -->
                        <path d="M60 200 Q100 120 140 200" fill="#4f46e5" />
                        <ellipse cx="100" cy="180" rx="45" ry="35" fill="#6366f1" />
                        
                        <!-- Paws -->
                        <ellipse cx="75" cy="200" rx="12" ry="8" fill="#e0e7ff" />
                        <ellipse cx="125" cy="200" rx="12" ry="8" fill="#e0e7ff" />
                        
                        <g id="head-group">
                            <!-- Ears -->
                            <path d="M55 45 L35 10 L75 35 Z" fill="#4338ca" />
                            <path d="M145 45 L165 10 L125 35 Z" fill="#4338ca" />
                            <path d="M60 40 L45 20 L70 35 Z" fill="#818cf8" />
                            <path d="M140 40 L155 20 L130 35 Z" fill="#818cf8" />
                            
                            <!-- Head Base -->
                            <circle cx="100" cy="100" r="80" fill="#6366f1" />
                            <circle cx="100" cy="110" r="62" fill="#e0e7ff" />
                            
                            <!-- Eyes -->
                            <g id="eyes">
                                <circle class="eye-lid" cx="78" cy="105" r="8" fill="#1e293b" />
                                <circle class="eye-lid" cx="122" cy="105" r="8" fill="#1e293b" />
                                <!-- Eye shine -->
                                <circle cx="80" cy="103" r="3" fill="white" opacity="0.6" />
                                <circle cx="124" cy="103" r="3" fill="white" opacity="0.6" />
                            </g>
                            
                            <!-- Nose -->
                            <path d="M95 125 L105 125 L100 132 Z" fill="#f472b6" />
                            
                            <!-- Mouth -->
                            <path id="mouth-path" d="M85 138 Q100 145 115 138" stroke="#1e293b" stroke-width="3" fill="none" stroke-linecap="round" />
                            
                            <!-- Whiskers -->
                            <g stroke="#1e293b" stroke-width="1.5" opacity="0.6">
                                <line x1="40" y1="115" x2="70" y2="120" />
                                <line x1="38" y1="125" x2="70" y2="125" />
                                <line x1="40" y1="135" x2="70" y2="130" />
                                <line x1="160" y1="115" x2="130" y2="120" />
                                <line x1="162" y1="125" x2="130" y2="125" />
                                <line x1="160" y1="135" x2="130" y2="130" />
                            </g>
                            
                            <!-- Cheeks -->
                            <circle cx="65" cy="125" r="8" fill="#f472b6" opacity="0.3" />
                            <circle cx="135" cy="125" r="8" fill="#f472b6" opacity="0.3" />
                        </g>
                    </svg>
                </div>
            </div>

            <!-- Controls -->
            <div class="absolute bottom-10 flex flex-col items-center gap-3 z-50">
                <div class="flex gap-3">
                    <button onclick="triggerEmotion('love')" class="w-12 h-12 bg-white rounded-full shadow-lg flex items-center justify-center text-lg hover:scale-110 transition-transform" title="Pet">ü•∞</button>
                    <button id="mic-btn" onclick="toggleMic()" class="w-16 h-16 bg-white rounded-full shadow-2xl flex items-center justify-center text-xl active:scale-90 transition-transform relative">
                        <i id="mic-icon" class="fas fa-microphone text-gray-300"></i>
                    </button>
                    <button onclick="triggerEmotion('sad')" class="w-12 h-12 bg-white rounded-full shadow-lg flex items-center justify-center text-lg hover:scale-110 transition-transform" title="Apologize">üòø</button>
                </div>
                <div class="flex gap-2 items-center bg-white/80 backdrop-blur px-4 py-2 rounded-full shadow">
                    <span id="lang-tag" class="text-[10px] font-bold text-indigo-600 uppercase tracking-tighter">EN ‚Üí BN</span>
                    <span class="text-gray-300">|</span>
                    <span id="emotion-tag" class="text-[10px] font-bold text-pink-500 uppercase tracking-tighter">NEUTRAL</span>
                </div>
            </div>
        </div>
    </main>

    <script>
        const STATE = {
            listening: false,
            speaking: false,
            emotion: 'neutral',
            lang: 'en-US',
            config: { 
                key: localStorage.getItem('cat_key') || '', 
                model: localStorage.getItem('cat_model') || 'google/gemini-2.0-flash-exp:free' 
            },
            touchTimer: null,
            isLongPress: false
        };

        const EMOTIONS = {
            neutral: { class: '', en: 'Meow! What can I do for you?', bn: '‡¶Æ‡¶ø‡¶â! ‡¶Ü‡¶Æ‡¶ø ‡¶ï‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶ø?' },
            happy: { class: 'emotion-happy', en: 'Purr... I love you too! üíï', bn: '‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶ó‡ßÅ‡¶∞‡ßÅ... ‡¶Ü‡¶Æ‡¶ø‡¶ì ‡¶§‡ßã‡¶Æ‡¶æ‡¶ï‡ßá ‡¶≠‡¶æ‡¶≤‡ßã‡¶¨‡¶æ‡¶∏‡¶ø! üíï' },
            sad: { class: 'emotion-sad', en: 'Meow... why are you scolding me? üòø', bn: '‡¶Æ‡¶ø‡¶â... ‡¶ï‡ßá‡¶® ‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶Ü‡¶Æ‡¶æ‡¶ï‡ßá ‡¶¨‡¶ï‡¶æ‡¶ù‡¶ï‡¶æ ‡¶ï‡¶∞‡¶õ‡ßã? üòø' },
            angry: { class: 'emotion-angry', en: 'Hiss! I am angry now! üòæ', bn: '‡¶∂‡ßç‡¶Ø‡¶æ‡¶ì! ‡¶Ü‡¶Æ‡¶ø ‡¶è‡¶ñ‡¶® ‡¶∞‡ßá‡¶ó‡ßá ‡¶Ü‡¶õ‡¶ø! üòæ' },
            love: { class: 'emotion-love', en: 'Purr purr... so happy! ü•∞', bn: '‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶ó‡ßÅ‡¶∞‡ßÅ... ‡¶ñ‡ßÅ‡¶∂‡¶ø! ü•∞' },
            scared: { class: 'emotion-scared', en: 'Eek! You scared me! üôÄ', bn: '‡¶ì‡¶π! ‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶Ü‡¶Æ‡¶æ‡¶ï‡ßá ‡¶≠‡¶Ø‡¶º ‡¶™‡¶æ‡¶á‡¶Ø‡¶º‡ßá ‡¶¶‡¶ø‡¶≤‡ßá! üôÄ' }
        };

        // --- EMOTION SYSTEM ---
        function setEmotion(emotion, duration = 5000) {
            const stage = document.getElementById('cat-stage');
            const tag = document.getElementById('emotion-tag');
            
            // Remove old emotions
            Object.keys(EMOTIONS).forEach(e => stage.classList.remove(EMOTIONS[e].class));
            
            STATE.emotion = emotion;
            stage.classList.add(EMOTIONS[emotion].class);
            tag.innerText = emotion.toUpperCase();
            
            // Special effects
            if (emotion === 'love') createHearts();
            if (emotion === 'sad') createTears();
            
            // Auto reset
            if (duration > 0) {
                setTimeout(() => {
                    if (STATE.emotion === emotion) setEmotion('neutral', 0);
                }, duration);
            }
        }

        function triggerEmotion(emotion) {
            setEmotion(emotion);
            speak(EMOTIONS[emotion].en, EMOTIONS[emotion].bn);
        }

        function createHearts() {
            const container = document.getElementById('cat-container');
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const heart = document.createElement('div');
                    heart.className = 'heart-particle';
                    heart.innerHTML = 'üíï';
                    heart.style.left = (80 + Math.random() * 40) + 'px';
                    heart.style.top = '50px';
                    container.appendChild(heart);
                    setTimeout(() => heart.remove(), 1500);
                }, i * 200);
            }
        }

        function createTears() {
            const eyes = document.getElementById('eyes');
            for (let i = 0; i < 2; i++) {
                const tear = document.createElement('div');
                tear.className = 'tear';
                tear.style.left = (i === 0 ? 74 : 118) + 'px';
                tear.style.top = '110px';
                eyes.appendChild(tear);
                setTimeout(() => tear.remove(), 1000);
            }
        }

        // --- TOUCH/CLICK INTERACTIONS ---
        function handleTap(e) {
            if (STATE.isLongPress) return;
            
            const rect = e.target.getBoundingClientRect();
            const x = e.clientX || (e.touches && e.touches[0].clientX);
            const relativeX = x - rect.left;
            
            // Left side = pet, Right side = scold
            if (relativeX < rect.width / 2) {
                triggerEmotion('love');
            } else {
                triggerEmotion('angry');
            }
        }

        function handleMouseDown(e) {
            STATE.isLongPress = false;
            STATE.touchTimer = setTimeout(() => {
                STATE.isLongPress = true;
                triggerEmotion('sad');
            }, 800);
            
            document.addEventListener('mouseup', () => {
                clearTimeout(STATE.touchTimer);
            }, { once: true });
        }

        function handleTouchStart(e) {
            STATE.isLongPress = false;
            STATE.touchTimer = setTimeout(() => {
                STATE.isLongPress = true;
                triggerEmotion('sad');
            }, 800);
        }

        function handleTouchEnd(e) {
            clearTimeout(STATE.touchTimer);
        }

        // Show hints on hover
        document.getElementById('cat-stage').addEventListener('mouseenter', () => {
            document.getElementById('hint-pet').style.opacity = '1';
            document.getElementById('hint-scold').style.opacity = '1';
        });
        document.getElementById('cat-stage').addEventListener('mouseleave', () => {
            document.getElementById('hint-pet').style.opacity = '0';
            document.getElementById('hint-scold').style.opacity = '0';
        });

        // --- AI & SPEECH (OpenRouter) ---
        async function callAI(text) {
            // Emotion detection from text
            const lower = text.toLowerCase();
            if (lower.includes('love') || lower.includes('‡¶≠‡¶æ‡¶≤‡ßã‡¶¨‡¶æ‡¶∏‡¶ø')) setEmotion('love');
            else if (lower.includes('bad') || lower.includes('scold') || lower.includes('‡¶¨‡¶ï‡¶æ') || lower.includes('‡¶ñ‡¶æ‡¶∞‡¶æ‡¶™')) setEmotion('sad');
            else if (lower.includes('angry') || lower.includes('‡¶∞‡¶æ‡¶ó')) setEmotion('angry');
            else if (lower.includes('sorry') || lower.includes('‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§')) setEmotion('love');

            if (!STATE.config.key) {
                alert("Please set your OpenRouter API Key in settings!");
                toggleSidebar();
                return;
            }

            updateUI('THINKING');
            
            // Prompt: Always respond in English, but provide Bangla translation
            const prompt = `You are a cute, emotional robot cat. Respond in English (max 2 sentences), then provide the Bangla translation on a new line starting with "BN:". 
            Current emotion: ${STATE.emotion}.
            User said: "${text}"`;

            try {
                const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: { 
                        "Authorization": `Bearer ${STATE.config.key}`, 
                        "Content-Type": "application/json",
                        "HTTP-Referer": window.location.href,
                        "X-Title": "AI Cat Companion"
                    },
                    body: JSON.stringify({
                        model: STATE.config.model,
                        messages: [{ role: 'user', content: prompt }]
                    })
                });
                
                const data = await res.json();
                const reply = data.choices[0].message.content;
                
                // Parse English and Bangla
                const lines = reply.split('\n');
                let english = lines[0].replace(/^EN:\s*/i, '').trim();
                let bangla = lines.find(l => l.startsWith('BN:'))?.replace('BN:', '').trim() || 
                            lines[1]?.replace(/^BN:\s*/i, '').trim() || 
                            "‡¶Ü‡¶Æ‡¶ø ‡¶¨‡ßÅ‡¶ù‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶ø‡¶®‡¶ø‡•§";
                
                document.getElementById('ai-caption').innerText = bangla;
                document.getElementById('english-sub').innerText = english;
                speak(english, bangla);
                
            } catch (e) { 
                console.error(e);
                updateUI('STANDBY');
                speak("Meow! Something went wrong.", "‡¶Æ‡¶ø‡¶â! ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§");
            }
        }

        function speak(englishText, banglaText) {
            STATE.speaking = true;
            window.speechSynthesis.cancel();
            
            const ut = new SpeechSynthesisUtterance(englishText);
            ut.lang = 'en-US';
            ut.rate = 1.1;
            ut.pitch = 1.2; // Higher pitch for cute cat voice
            
            const mouth = document.getElementById('mouth-path');
            let anim;
            
            ut.onstart = () => {
                updateUI('SPEAKING');
                document.body.classList.add('is-talking');
                // Animate mouth
                anim = setInterval(() => {
                    const open = Math.random() > 0.5;
                    mouth.setAttribute('d', open ? 'M85 138 Q100 155 115 138' : 'M85 138 Q100 145 115 138');
                }, 100);
            };
            
            ut.onend = () => {
                STATE.speaking = false;
                clearInterval(anim);
                mouth.setAttribute('d', 'M85 138 Q100 145 115 138');
                document.body.classList.remove('is-talking');
                updateUI('STANDBY');
                if (STATE.listening) setTimeout(() => rec.start(), 300);
            };
            
            window.speechSynthesis.speak(ut);
        }

        // --- SPEECH RECOGNITION ---
        const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
        const rec = Rec ? new Rec() : null;
        
        if(rec) {
            rec.lang = 'en-US'; // Always listen for English
            rec.continuous = false;
            rec.interimResults = false;
            
            rec.onstart = () => {
                updateUI('LISTENING');
                document.body.classList.add('is-listening');
            };
            
            rec.onresult = (e) => {
                const txt = e.results[0][0].transcript;
                document.getElementById('user-transcript').innerText = txt;
                callAI(txt);
            };
            
            rec.onend = () => {
                document.body.classList.remove('is-listening');
                if(STATE.listening && !STATE.speaking) {
                    setTimeout(() => { try{rec.start()}catch(e){} }, 500);
                }
            };
            
            rec.onerror = () => {
                document.body.classList.remove('is-listening');
                updateUI('STANDBY');
            };
        }

        function toggleMic() {
            if (!rec) {
                alert("Speech recognition not supported in this browser. Please use Chrome.");
                return;
            }
            
            STATE.listening = !STATE.listening;
            if(STATE.listening) {
                rec.start();
            } else {
                rec.stop();
                updateUI('STANDBY');
            }
        }

        function sendText() {
            const input = document.getElementById('text-input');
            if(!input.value.trim()) return;
            document.getElementById('user-transcript').innerText = input.value;
            callAI(input.value);
            input.value = '';
            input.blur();
        }

        // --- UI HELPERS ---
        function updateUI(status) {
            const icon = document.getElementById('mic-icon');
            const btn = document.getElementById('mic-btn');
            
            if (status === 'LISTENING') {
                icon.className = "fas fa-microphone text-indigo-600 animate-pulse";
                btn.classList.add('ring-4', 'ring-indigo-200');
            }
            else if (status === 'SPEAKING') {
                icon.className = "fas fa-volume-up text-green-500";
                btn.classList.remove('ring-4', 'ring-indigo-200');
            }
            else if (status === 'THINKING') {
                icon.className = "fas fa-circle-notch fa-spin text-orange-500";
                btn.classList.remove('ring-4', 'ring-indigo-200');
            }
            else {
                icon.className = "fas fa-microphone text-gray-300";
                btn.classList.remove('ring-4', 'ring-indigo-200');
            }
        }

        function toggleSidebar() {
            const el = document.getElementById('sidebar');
            const open = el.style.transform === 'translateX(0px)';
            el.style.transform = open ? 'translateX(-100%)' : 'translateX(0px)';
            document.getElementById('overlay').style.display = open ? 'none' : 'block';
        }

        function saveSettings() {
            STATE.config.key = document.getElementById('api-key').value;
            STATE.config.model = document.getElementById('model-profile').value;
            localStorage.setItem('cat_key', STATE.config.key);
            localStorage.setItem('cat_model', STATE.config.model);
            toggleSidebar();
            speak("Settings saved!", "‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!");
        }

        // --- INITIALIZATION ---
        window.onload = () => {
            // Load settings
            document.getElementById('api-key').value = STATE.config.key;
            document.getElementById('model-profile').value = STATE.config.model;
            
            // Draggable bubble
            const bubble = document.getElementById('speech-bubble');
            let px=0, py=0, ix, iy;
            document.getElementById('drag-handle').onpointerdown = (e) => {
                ix = e.clientX - px; 
                iy = e.clientY - py;
                document.onpointermove = (ev) => {
                    px = ev.clientX - ix; 
                    py = ev.clientY - iy;
                    bubble.style.transform = `translate3d(${px}px, ${py}px, 0)`;
                };
                document.onpointerup = () => document.onpointermove = null;
            };
            
            // Blink animation
            setInterval(() => {
                document.getElementById('eyes').classList.add('blink');
                setTimeout(() => document.getElementById('eyes').classList.remove('blink'), 150);
            }, 4000 + Math.random() * 2000);
            
            // Welcome message
            setTimeout(() => {
                speak("Hello! I'm your smart cat. Tap me or talk to me!", 
                      "‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã! ‡¶Ü‡¶Æ‡¶ø ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶¨‡ßÅ‡¶¶‡ßç‡¶ß‡¶ø‡¶Æ‡¶æ‡¶® ‡¶¨‡¶ø‡¶°‡¶º‡¶æ‡¶≤‡•§ ‡¶Ü‡¶Æ‡¶æ‡¶ï‡ßá ‡¶ü‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡¶∞‡ßã ‡¶¨‡¶æ ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡ßã!");
            }, 1000);
        };
    </script>
</body>
</html>
