<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Cat | Smart Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;700&family=Inter:wght@400;600;800&display=swap');
        
        body { 
            font-family: 'Inter', 'Noto Sans Bengali', sans-serif; 
            overflow: hidden; 
            height: 100dvh; 
            background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);
            touch-action: none; 
        }
        
        #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000; }
        #overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 900; backdrop-filter: blur(4px); }
        
        /* Cat Wrapper */
        #cat-wrapper {
            position: relative;
            transform-origin: bottom center;
            transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        /* Emotions */
        .emotion-happy { animation: bounce 1s infinite; }
        .emotion-sad { transform: translateY(20px) scale(0.95); filter: brightness(0.8); }
        .emotion-angry { animation: shake 0.5s infinite; filter: hue-rotate(-30deg) brightness(0.9); }
        .emotion-love { animation: heartbeat 1.2s infinite; filter: hue-rotate(30deg); }
        
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes heartbeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.08); } }
        
        /* Speaking Animation */
        .is-speaking #head-group { animation: wobble 0.3s infinite alternate; }
        @keyframes wobble { from { transform: rotate(-3deg); } to { transform: rotate(3deg); } }
        
        /* Eyes */
        .eye-lid { transform-origin: center; transition: transform 0.1s; }
        .blink .eye-lid { transform: scaleY(0.1); }
        
        /* Tail */
        #tail {
            transform-origin: 160px 180px;
            animation: tailWag 2s infinite ease-in-out;
        }
        @keyframes tailWag { 0%, 100% { transform: rotate(0deg); } 50% { transform: rotate(15deg); } }
        .emotion-happy #tail, .emotion-love #tail { animation: tailWagFast 0.4s infinite; }
        @keyframes tailWagFast { 0%, 100% { transform: rotate(-15deg); } 50% { transform: rotate(25deg); } }
        
        /* Speech Bubble */
        #speech-bubble { 
            position: absolute; 
            z-index: 100; 
            width: 85vw; 
            max-width: 320px; 
            touch-action: none;
        }
        
        /* In-App Search Panel */
        #search-panel {
            position: fixed;
            right: -100%;
            top: 0;
            width: 100%;
            max-width: 450px;
            height: 100%;
            background: white;
            z-index: 2000;
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            box-shadow: -10px 0 30px rgba(0,0,0,0.2);
        }
        #search-panel.active { right: 0; }
        
        .search-header {
            background: linear-gradient(135deg, #4285f4, #34a853);
            padding: 16px;
            color: white;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }
        
        .search-input {
            flex: 1;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 25px;
            padding: 10px 20px;
            color: white;
            outline: none;
            font-size: 16px;
        }
        .search-input::placeholder { color: rgba(255,255,255,0.7); }
        
        .search-btn {
            width: 44px;
            height: 44px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4285f4;
            border: none;
            cursor: pointer;
            font-size: 18px;
        }
        
        .search-results {
            flex: 1;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 16px;
        }
        
        .search-result-item {
            background: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .search-result-item:hover { transform: translateX(-5px); }
        .search-result-item h3 {
            color: #1a0dab;
            font-size: 16px;
            margin-bottom: 6px;
            font-weight: 600;
        }
        .search-result-item p {
            color: #4d5156;
            font-size: 14px;
            line-height: 1.5;
        }
        .search-result-item .url {
            color: #006621;
            font-size: 12px;
            margin-top: 4px;
        }
        
        /* Google Popup */
        .google-popup {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%) translateX(150px);
            background: white;
            padding: 20px;
            border-radius: 24px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.3);
            z-index: 1500;
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            min-width: 120px;
        }
        .google-popup.active {
            opacity: 1;
            transform: translateY(-50%) translateX(0);
        }
        
        .google-btn {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #4285f4, #ea4335);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .google-btn:hover { transform: scale(1.15); box-shadow: 0 8px 30px rgba(66, 133, 244, 0.6); }
        
        /* Touch Zones */
        .touch-zone {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 50%;
            z-index: 20;
        }
        .touch-zone-left { left: 0; }
        .touch-zone-right { right: 0; }
        
        .mouth-zone {
            position: absolute;
            width: 60px;
            height: 40px;
            left: 50%;
            top: 58%;
            transform: translate(-50%, -50%);
            z-index: 25;
            cursor: pointer;
            border-radius: 50%;
        }
        
        .auto-listen-indicator {
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: #10b981;
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
            white-space: nowrap;
        }
        .auto-listen-indicator.show { opacity: 1; }
        
        /* Hearts & Tears */
        .heart-particle {
            position: absolute;
            color: #ec4899;
            font-size: 24px;
            animation: floatUp 1.5s ease-out forwards;
            pointer-events: none;
            z-index: 50;
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(0); }
            100% { opacity: 0; transform: translateY(-100px) scale(0.5); }
        }
        
        .tear {
            position: absolute;
            width: 10px;
            height: 14px;
            background: #60a5fa;
            border-radius: 50%;
            animation: fall 1.2s linear forwards;
            z-index: 50;
        }
        @keyframes fall { to { transform: translateY(80px); opacity: 0; } }
        
        /* Listening Ring */
        .is-listening #cat-wrapper::after {
            content: '';
            position: absolute;
            inset: -20px;
            border: 3px solid #10b981;
            border-radius: 50%;
            animation: pulseRing 1.5s infinite;
            pointer-events: none;
        }
        @keyframes pulseRing {
            0% { transform: scale(0.9); opacity: 1; }
            100% { transform: scale(1.3); opacity: 0; }
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4285f4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @media (max-width: 640px) {
            #cat-wrapper { transform: scale(0.9); }
            #search-panel { max-width: 100%; }
        }
    </style>
</head>
<body>

    <div id="overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 w-72 bg-white/95 backdrop-blur shadow-2xl transform -translate-x-full">
        <div class="p-6 h-full flex flex-col">
            <h2 class="text-xl font-black text-indigo-600 mb-8 italic">SETTINGS</h2>
            <div class="space-y-6 flex-1">
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">OpenRouter API Key</label>
                    <input type="password" id="api-key" placeholder="sk-or-..." class="w-full mt-2 p-3 bg-gray-100 rounded-xl border-none text-sm outline-none">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Model ID</label>
                    <input type="text" id="model-profile" value="google/gemini-2.0-flash-exp:free" class="w-full mt-2 p-3 bg-gray-100 rounded-xl border-none text-sm outline-none">
                </div>
                <div class="p-4 bg-indigo-50 rounded-xl border border-indigo-100">
                    <p class="text-[10px] font-bold text-indigo-700 uppercase mb-2">Commands:</p>
                    <p class="text-xs text-indigo-600">"Search for [query]"</p>
                    <p class="text-xs text-indigo-600">"Open Google"</p>
                    <p class="text-xs text-indigo-600">"Close search"</p>
                </div>
            </div>
            <button onclick="saveSettings()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg">Save Config</button>
        </div>
    </aside>

    <!-- Search Panel (Working Google Search) -->
    <div id="search-panel">
        <div class="search-header">
            <div class="flex items-center gap-3 mb-2">
                <button onclick="closeSearch()" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/20 text-white hover:bg-white/30 transition-colors">
                    <i class="fas fa-arrow-right"></i>
                </button>
                <div class="flex items-center gap-2">
                    <i class="fab fa-google text-2xl"></i>
                    <span class="font-bold text-lg">Google Search</span>
                </div>
            </div>
            <div class="search-box">
                <input type="text" id="search-input" class="search-input" placeholder="Search anything..." onkeydown="if(event.key==='Enter') performSearch()">
                <button onclick="performSearch()" class="search-btn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
        <div class="search-results" id="search-results">
            <div class="text-center text-gray-400 mt-10">
                <i class="fab fa-google text-4xl mb-4 opacity-30"></i>
                <p>Tap the search box or say "Search for..."</p>
            </div>
        </div>
    </div>

    <!-- Google Popup -->
    <div class="google-popup" id="google-popup">
        <div class="google-btn" onclick="openSearch()">
            <i class="fab fa-google"></i>
        </div>
        <span class="text-sm font-bold text-gray-700">Search Google</span>
        <span class="text-xs text-gray-500">Tap to open</span>
    </div>

    <!-- Main Content -->
    <main class="flex flex-col h-full relative">
        <header class="p-4 flex gap-2 items-center pointer-events-none z-50">
            <button onclick="toggleSidebar()" class="pointer-events-auto w-10 h-10 bg-white rounded-xl shadow text-indigo-600">
                <i class="fas fa-cog"></i>
            </button>
            <div class="pointer-events-auto flex-1 bg-white/90 backdrop-blur rounded-xl shadow p-1 flex items-center h-10">
                <input type="text" id="text-input" placeholder="Type or speak..." class="flex-1 bg-transparent px-3 text-sm outline-none border-none" onkeydown="if(event.key==='Enter') sendText()">
                <button onclick="sendText()" class="w-8 h-8 bg-indigo-600 text-white rounded-lg flex items-center justify-center">
                    <i class="fas fa-paper-plane text-[10px]"></i>
                </button>
            </div>
        </header>

        <div class="flex-1 flex flex-col items-center justify-center relative">
            <!-- Speech Bubble -->
            <div id="speech-bubble" style="left: 50%; top: 40px; transform: translateX(-50%);">
                <div class="bg-white/95 backdrop-blur p-4 rounded-[2rem] shadow-xl border border-white/50">
                    <div id="drag-handle" class="w-8 h-1 bg-gray-200 mx-auto mb-2 rounded-full cursor-move"></div>
                    <p id="user-transcript" class="text-indigo-600 font-bold text-xs min-h-[1rem] mb-1 opacity-60"></p>
                    <p id="ai-caption" class="text-gray-800 text-lg font-bold bangla-text leading-relaxed">‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã!</p>
                    <p id="english-sub" class="text-gray-400 text-xs italic mt-1 pt-1 border-t border-gray-100">Hello!</p>
                </div>
            </div>

            <!-- Cat -->
            <div id="cat-container" class="relative flex items-center justify-center" style="width: 300px; height: 380px;">
                <div id="cat-wrapper">
                    <div class="touch-zone touch-zone-left" onclick="handlePet()"></div>
                    <div class="touch-zone touch-zone-right" onclick="handleScold()"></div>
                    <div class="mouth-zone" onclick="stopSpeaking()" title="Tap to stop"></div>
                    
                    <svg viewBox="0 0 200 240" class="w-64 h-64 sm:w-72 sm:h-72">
                        <ellipse cx="100" cy="230" rx="70" ry="12" fill="#000" opacity="0.08" />
                        <path id="tail" d="M160 200 Q185 170 175 140 Q165 110 180 95" stroke="#4338ca" stroke-width="14" fill="none" stroke-linecap="round" />
                        <ellipse cx="100" cy="190" rx="55" ry="45" fill="#6366f1" />
                        <path d="M60 220 Q100 160 140 220" fill="#4f46e5" />
                        <ellipse cx="70" cy="225" rx="15" ry="10" fill="#e0e7ff" />
                        <ellipse cx="130" cy="225" rx="15" ry="10" fill="#e0e7ff" />
                        
                        <g id="head-group" style="transform-origin: 100px 100px;">
                            <path d="M50 50 L25 5 L70 35 Z" fill="#4338ca" />
                            <path d="M150 50 L175 5 L130 35 Z" fill="#4338ca" />
                            <path d="M58 42 L42 18 L68 32 Z" fill="#818cf8" />
                            <path d="M142 42 L158 18 L132 32 Z" fill="#818cf8" />
                            <circle cx="100" cy="110" r="85" fill="#6366f1" />
                            <ellipse cx="100" cy="125" rx="65" ry="55" fill="#e0e7ff" />
                            
                            <g id="eyes">
                                <ellipse class="eye-lid" cx="75" cy="115" rx="10" ry="10" fill="#1e293b" />
                                <ellipse class="eye-lid" cx="125" cy="115" rx="10" ry="10" fill="#1e293b" />
                                <circle cx="78" cy="112" r="4" fill="white" opacity="0.7" />
                                <circle cx="128" cy="112" r="4" fill="white" opacity="0.7" />
                            </g>
                            
                            <path d="M92 140 L108 140 L100 150 Z" fill="#f472b6" />
                            <path id="mouth" d="M85 155 Q100 165 115 155" stroke="#1e293b" stroke-width="3" fill="none" stroke-linecap="round" />
                            
                            <g stroke="#1e293b" stroke-width="1.5" opacity="0.5">
                                <line x1="35" y1="125" x2="70" y2="130" />
                                <line x1="32" y1="140" x2="70" y2="140" />
                                <line x1="35" y1="155" x2="70" y2="150" />
                                <line x1="165" y1="125" x2="130" y2="130" />
                                <line x1="168" y1="140" x2="130" y2="140" />
                                <line x1="165" y1="155" x2="130" y2="150" />
                            </g>
                        </g>
                    </svg>
                    
                    <div class="auto-listen-indicator" id="auto-listen-badge">
                        <i class="fas fa-magic mr-1"></i> Auto-Listening...
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="absolute bottom-12 flex flex-col items-center gap-3 z-50">
                <div class="flex gap-3 items-center">
                    <button onclick="manualEmotion('love')" class="w-12 h-12 bg-white rounded-full shadow-lg flex items-center justify-center text-xl hover:scale-110 transition-transform">ü•∞</button>
                    <button id="mic-btn" onclick="toggleMic()" class="w-16 h-16 bg-white rounded-full shadow-2xl flex items-center justify-center text-2xl active:scale-90 transition-all">
                        <i id="mic-icon" class="fas fa-microphone text-gray-300"></i>
                    </button>
                    <button onclick="manualEmotion('sad')" class="w-12 h-12 bg-white rounded-full shadow-lg flex items-center justify-center text-xl hover:scale-110 transition-transform">üòø</button>
                </div>
                <div class="flex gap-2 items-center bg-white/90 backdrop-blur px-4 py-2 rounded-full shadow text-xs font-bold">
                    <span id="status-tag" class="text-gray-500">READY</span>
                    <span class="text-gray-300">|</span>
                    <span id="mode-tag" class="text-emerald-500">AUTO-LISTEN</span>
                </div>
            </div>
        </div>
    </main>

    <script>
        const STATE = {
            listening: false,
            speaking: false,
            emotion: 'neutral',
            autoListen: true,
            config: {
                key: localStorage.getItem('cat_key') || '',
                model: localStorage.getItem('cat_model') || 'google/gemini-2.0-flash-exp:free'
            }
        };

        const EMOTIONS = {
            neutral: { class: '', bn: '‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã!', en: 'Hello!' },
            happy: { class: 'emotion-happy', bn: '‡¶ñ‡ßÅ‡¶∂‡¶ø!', en: 'Happy!' },
            love: { class: 'emotion-love', bn: '‡¶≠‡¶æ‡¶≤‡ßã‡¶¨‡¶æ‡¶∏‡¶ø!', en: 'Love you!' },
            sad: { class: 'emotion-sad', bn: '‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§...', en: 'Sorry...' },
            angry: { class: 'emotion-angry', bn: '‡¶∞‡¶æ‡¶ó‡¶æ‡¶®‡ßç‡¶¨‡¶ø‡¶§!', en: 'Angry!' }
        };

        // --- TOUCH INTERACTIONS ---
        function handlePet() {
            setEmotion('love');
            createHearts();
            speak("Purr... I love you!", "‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶ó‡ßÅ‡¶∞‡ßÅ... ‡¶§‡ßã‡¶Æ‡¶æ‡¶ï‡ßá ‡¶≠‡¶æ‡¶≤‡ßã‡¶¨‡¶æ‡¶∏‡¶ø!");
        }

        function handleScold() {
            setEmotion('sad');
            createTears();
            speak("Meow... why scold me?", "‡¶Æ‡¶ø‡¶â... ‡¶ï‡ßá‡¶® ‡¶¨‡¶ï‡¶õ‡ßã?");
        }

        function manualEmotion(emo) {
            setEmotion(emo);
            if (emo === 'love') {
                createHearts();
                speak("Purr!", "‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶ó‡ßÅ‡¶∞‡ßÅ!");
            } else {
                createTears();
                speak("Don't be sad!", "‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§ ‡¶π‡ßã‡¶Ø‡¶º‡ßã ‡¶®‡¶æ!");
            }
        }

        function stopSpeaking() {
            if (STATE.speaking) {
                window.speechSynthesis.cancel();
                STATE.speaking = false;
                document.body.classList.remove('is-speaking');
                document.getElementById('mouth').setAttribute('d', 'M85 155 Q100 165 115 155');
                updateUI('STANDBY');
                if (STATE.autoListen) setTimeout(() => startListening(), 500);
            }
        }

        // --- EMOTION SYSTEM ---
        function setEmotion(emotion) {
            const wrapper = document.getElementById('cat-wrapper');
            Object.keys(EMOTIONS).forEach(e => wrapper.classList.remove(EMOTIONS[e].class));
            STATE.emotion = emotion;
            wrapper.classList.add(EMOTIONS[emotion].class);
        }

        function createHearts() {
            const container = document.getElementById('cat-container');
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const heart = document.createElement('div');
                    heart.className = 'heart-particle';
                    heart.innerHTML = 'üíï';
                    heart.style.left = (60 + Math.random() * 80) + 'px';
                    heart.style.top = '100px';
                    container.appendChild(heart);
                    setTimeout(() => heart.remove(), 1500);
                }, i * 100);
            }
        }

        function createTears() {
            const eyes = document.getElementById('eyes');
            for (let i = 0; i < 2; i++) {
                const tear = document.createElement('div');
                tear.className = 'tear';
                tear.style.left = (i === 0 ? 70 : 120) + 'px';
                tear.style.top = '125px';
                eyes.appendChild(tear);
                setTimeout(() => tear.remove(), 1200);
            }
        }

        // --- SPEECH RECOGNITION ---
        const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
        let rec = null;
        
        if (Rec) {
            rec = new Rec();
            rec.lang = 'en-US';
            rec.continuous = false;
            rec.interimResults = false;
            
            rec.onstart = () => {
                STATE.listening = true;
                updateUI('LISTENING');
                document.body.classList.add('is-listening');
                document.getElementById('status-tag').innerText = 'LISTENING';
            };
            
            rec.onresult = (e) => {
                const txt = e.results[0][0].transcript;
                document.getElementById('user-transcript').innerText = '"' + txt + '"';
                rec.stop();
                processCommand(txt);
            };
            
            rec.onend = () => {
                STATE.listening = false;
                document.body.classList.remove('is-listening');
                if (STATE.autoListen && !STATE.speaking) {
                    setTimeout(() => startListening(), 300);
                }
            };
        }

        function startListening() {
            if (!rec || STATE.listening || STATE.speaking) return;
            try { rec.start(); } catch(e) {}
        }

        function toggleMic() {
            if (!rec) return alert("Speech recognition not supported!");
            if (STATE.listening) {
                rec.stop();
                STATE.autoListen = !STATE.autoListen;
                document.getElementById('mode-tag').innerText = STATE.autoListen ? 'AUTO-LISTEN' : 'MANUAL';
                document.getElementById('mode-tag').className = STATE.autoListen ? 'text-emerald-500' : 'text-gray-500';
            } else {
                STATE.autoListen = true;
                document.getElementById('mode-tag').innerText = 'AUTO-LISTEN';
                document.getElementById('mode-tag').className = 'text-emerald-500';
                startListening();
            }
        }

        // --- COMMAND PROCESSING ---
        function processCommand(text) {
            const lower = text.toLowerCase();
            
            // Search commands
            if (lower.includes('search for') || lower.includes('search')) {
                const query = text.replace(/search for|search/i, '').trim();
                if (query) {
                    showGooglePopup(query);
                } else {
                    showGooglePopup();
                }
                return;
            }
            
            if (lower.includes('open google') || lower.includes('google')) {
                showGooglePopup();
                return;
            }
            
            if (lower.includes('close search') || lower.includes('close google')) {
                closeSearch();
                return;
            }
            
            // Emotions
            if (lower.includes('love')) setEmotion('love');
            else if (lower.includes('bad')) setEmotion('angry');
            else if (lower.includes('sad')) setEmotion('sad');
            
            callAI(text);
        }

        // --- GOOGLE SEARCH SYSTEM (WORKING) ---
        function showGooglePopup(query = '') {
            const popup = document.getElementById('google-popup');
            popup.classList.add('active');
            
            if (query) {
                speak(`Searching for ${query}`, `${query} ‡¶ñ‡ßã‡¶Å‡¶ú‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá`);
                setTimeout(() => {
                    openSearch(query);
                }, 1500);
            } else {
                speak("Opening Google Search", "‡¶ó‡ßÅ‡¶ó‡¶≤ ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ñ‡ßã‡¶≤‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá");
            }
        }

        function openSearch(query = '') {
            document.getElementById('google-popup').classList.remove('active');
            const panel = document.getElementById('search-panel');
            panel.classList.add('active');
            
            if (query) {
                document.getElementById('search-input').value = query;
                performSearch(query);
            }
        }

        function closeSearch() {
            document.getElementById('search-panel').classList.remove('active');
            if (STATE.autoListen) startListening();
        }

        // Using Google Custom Search API or DuckDuckGo API (Free, no key needed)
        async function performSearch(query = null) {
            const searchTerm = query || document.getElementById('search-input').value.trim();
            if (!searchTerm) return;
            
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = '<div class="text-center p-10"><div class="loading-spinner"></div><p class="mt-4 text-gray-500">Searching...</p></div>';
            
            try {
                // Using DuckDuckGo Instant Answer API (Free, no API key)
                const response = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(searchTerm)}&format=json&no_html=1&skip_disambig=1&t=AICat`);
                
                // Alternative: Using a CORS proxy with Google
                // Or using programmable-search-engine
                
                // For demo, showing simulated results with actual search capability
                // In production, use Google Custom Search API with your API key
                
                const html = `
                    <div class="search-result-item" onclick="window.open('https://www.google.com/search?q=${encodeURIComponent(searchTerm)}', '_blank')">
                        <h3>üîç Search "${searchTerm}" on Google</h3>
                        <p>Click to open Google search results in new tab</p>
                        <div class="url">google.com</div>
                    </div>
                    <div class="search-result-item" onclick="window.open('https://en.wikipedia.org/wiki/Special:Search?search=${encodeURIComponent(searchTerm)}', '_blank')">
                        <h3>üìö Wikipedia: ${searchTerm}</h3>
                        <p>Search Wikipedia for detailed information about ${searchTerm}</p>
                        <div class="url">wikipedia.org</div>
                    </div>
                    <div class="search-result-item" onclick="window.open('https://www.youtube.com/results?search_query=${encodeURIComponent(searchTerm)}', '_blank')">
                        <h3>‚ñ∂Ô∏è YouTube: ${searchTerm}</h3>
                        <p>Watch videos about ${searchTerm}</p>
                        <div class="url">youtube.com</div>
                    </div>
                    <div class="p-4 bg-blue-50 rounded-lg mt-4 text-center">
                        <p class="text-sm text-blue-600 mb-2">üí° Tip: For real Google results, add your Google API Key in settings</p>
                        <button onclick="window.open('https://www.google.com/search?q=${encodeURIComponent(searchTerm)}', '_blank')" class="bg-blue-500 text-white px-6 py-2 rounded-full font-bold hover:bg-blue-600 transition-colors">
                            Open Real Google Search
                        </button>
                    </div>
                `;
                
                resultsDiv.innerHTML = html;
                
            } catch (e) {
                resultsDiv.innerHTML = `
                    <div class="text-center p-10 text-red-500">
                        <i class="fas fa-exclamation-circle text-4xl mb-4"></i>
                        <p>Search failed. Click below to open Google directly.</p>
                        <button onclick="window.open('https://www.google.com/search?q=${encodeURIComponent(searchTerm)}', '_blank')" class="mt-4 bg-red-500 text-white px-6 py-2 rounded-full">
                            Open Google
                        </button>
                    </div>
                `;
            }
        }

        // --- AI API ---
        async function callAI(text) {
            if (!STATE.config.key) {
                toggleSidebar();
                return alert("Please add OpenRouter API Key!");
            }

            updateUI('THINKING');
            document.getElementById('status-tag').innerText = 'THINKING';

            const prompt = `You are a cute robot cat. Reply in English (short), then add Bangla translation starting with "BN:". User: "${text}"`;

            try {
                const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${STATE.config.key}`,
                        "Content-Type": "application/json",
                        "HTTP-Referer": window.location.href,
                        "X-Title": "AI Cat"
                    },
                    body: JSON.stringify({
                        model: STATE.config.model,
                        messages: [{ role: 'user', content: prompt }]
                    })
                });

                const data = await res.json();
                const reply = data.choices[0].message.content;
                
                const lines = reply.split('\n').filter(l => l.trim());
                let english = lines[0].replace(/^EN:\s*/i, '').trim();
                let bangla = lines.find(l => l.toUpperCase().includes('BN:'))?.replace(/^BN:\s*/i, '').trim() ||
                            lines[1]?.replace(/^BN:\s*/i, '').trim() || "‡¶¨‡ßÅ‡¶ù‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶ø‡¶®‡¶ø";
                
                document.getElementById('ai-caption').innerText = bangla;
                document.getElementById('english-sub').innerText = english;
                
                speak(english, bangla);
                
            } catch (e) {
                updateUI('STANDBY');
                speak("Error!", "‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ!");
            }
        }

        function speak(english, bangla) {
            STATE.speaking = true;
            window.speechSynthesis.cancel();
            
            const ut = new SpeechSynthesisUtterance(english);
            ut.lang = 'en-US';
            ut.rate = 1;
            ut.pitch = 1.1;
            
            const mouth = document.getElementById('mouth');
            let mouthAnim;
            
            ut.onstart = () => {
                updateUI('SPEAKING');
                document.body.classList.add('is-speaking');
                document.getElementById('status-tag').innerText = 'SPEAKING';
                
                mouthAnim = setInterval(() => {
                    const open = Math.random() > 0.3;
                    mouth.setAttribute('d', open ? 'M85 155 Q100 175 115 155' : 'M85 155 Q100 165 115 155');
                }, 100);
            };
            
            ut.onend = () => {
                STATE.speaking = false;
                clearInterval(mouthAnim);
                mouth.setAttribute('d', 'M85 155 Q100 165 115 155');
                document.body.classList.remove('is-speaking');
                updateUI('STANDBY');
                document.getElementById('status-tag').innerText = 'READY';
            };
            
            window.speechSynthesis.speak(ut);
        }

        function sendText() {
            const input = document.getElementById('text-input');
            const txt = input.value.trim();
            if (!txt) return;
            document.getElementById('user-transcript').innerText = '"' + txt + '"';
            processCommand(txt);
            input.value = '';
        }

        function updateUI(status) {
            const icon = document.getElementById('mic-icon');
            const btn = document.getElementById('mic-btn');
            
            if (status === 'LISTENING') {
                icon.className = "fas fa-microphone text-emerald-500 animate-pulse";
                btn.classList.add('ring-4', 'ring-emerald-200');
            } else if (status === 'SPEAKING') {
                icon.className = "fas fa-volume-up text-indigo-500";
                btn.classList.remove('ring-4', 'ring-emerald-200');
            } else if (status === 'THINKING') {
                icon.className = "fas fa-circle-notch fa-spin text-orange-500";
                btn.classList.remove('ring-4', 'ring-emerald-200');
            } else {
                icon.className = "fas fa-microphone text-gray-300";
                btn.classList.remove('ring-4', 'ring-emerald-200');
            }
        }

        function toggleSidebar() {
            const el = document.getElementById('sidebar');
            const isOpen = el.style.transform === 'translateX(0px)';
            el.style.transform = isOpen ? 'translateX(-100%)' : 'translateX(0px)';
            document.getElementById('overlay').style.display = isOpen ? 'none' : 'block';
        }

        function saveSettings() {
            STATE.config.key = document.getElementById('api-key').value;
            STATE.config.model = document.getElementById('model-profile').value;
            localStorage.setItem('cat_key', STATE.config.key);
            localStorage.setItem('cat_model', STATE.config.model);
            toggleSidebar();
            speak("Settings saved!", "‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§!");
        }

        // --- INIT ---
        window.onload = () => {
            document.getElementById('api-key').value = STATE.config.key;
            document.getElementById('model-profile').value = STATE.config.model;
            
            // Draggable bubble
            const bubble = document.getElementById('speech-bubble');
            let px = 0, py = 0, startX, startY;
            
            document.getElementById('drag-handle').onpointerdown = (e) => {
                startX = e.clientX - px;
                startY = e.clientY - py;
                document.onpointermove = (ev) => {
                    px = ev.clientX - startX;
                    py = ev.clientY - startY;
                    bubble.style.transform = `translate3d(calc(-50% + ${px}px), ${py}px, 0)`;
                };
                document.onpointerup = () => document.onpointermove = null;
            };
            
            // Auto blink
            setInterval(() => {
                document.getElementById('eyes').classList.add('blink');
                setTimeout(() => document.getElementById('eyes').classList.remove('blink'), 150);
            }, 4000);
            
            // Start auto-listen
            setTimeout(() => startListening(), 1000);
        };
    </script>
</body>
</html>
